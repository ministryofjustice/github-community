{% extends "shared/components/base.html" %}

{% block pageTitle %}
   Platform Access Summary
{% endblock %}

{% block content %}
<h1 class="govuk-heading-l">Platform Access Summary</h1>
  <p class="govuk-body">
    This page details all access roles being used across Modernisation Platform environments.
  </p>
  <p class="govuk-body">
    Consult our <a class="govuk-link" href="https://user-guide.modernisation-platform.service.justice.gov.uk/user-guide/platform-user-roles.html">documentation</a> for more information on platform user roles.
  </p>

  <!-- Chart Section -->
  <section class="govuk-!-margin-bottom-6">
    <h2 class="govuk-heading-m">Access Role Usage</h2>
    <p class="govuk-body-s">Each count represents one role assigned to one environment, regardless of how many teams have that role.</p>
    <div style="max-width: 800px; margin: 0 auto;">
      <canvas id="roleUsageChart"></canvas>
    </div>
  </section>

  <!-- Text Summary (kept for accessibility) -->
  <details class="govuk-details">
    <summary class="govuk-details__summary">
      <span class="govuk-details__summary-text">View detailed role counts</span>
    </summary>
    <div class="govuk-details__text">
      <dl class="govuk-summary-list">
        {% for role, count in role_counts.items() %}
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key">{{ role }}</dt>
          <dd class="govuk-summary-list__value">{{ count }}</dd>
        </div>
        {% endfor %}
      </dl>
    </div>
  </details>

  <section>
    <h2 class="govuk-heading-m">All Environments and Access</h2>

    <input type="text" id="access-search" class="govuk-input" placeholder="Search apps, environments, group name, access level..." style="margin-bottom: 1em;">
    <table class="govuk-table">
      <thead>
        <tr>
          <th class="govuk-table__header">App Name</th>
          <th class="govuk-table__header">Environment</th>
          <th class="govuk-table__header">Access Level</th>
          <th class="govuk-table__header">Group Name(s)</th>
        </tr>
      </thead>
      <tbody id="access-table-body">
        {% for item in access_items %}
          {% if item.access_details|length > 0 %}
            {% for detail in item.access_details %}
        <tr data-app-name="{{ item.app_name }}">
          {% if loop.first %}
          <td class="govuk-table__cell" rowspan="{{ item.access_details|length }}" data-is-app-cell="true">{{ item.app_name }}</td>
          {% endif %}
          <td class="govuk-table__cell">{{ detail.environment }}</td>
          <td class="govuk-table__cell">{{ detail.access_level }}</td>
          <td class="govuk-table__cell">
            {% for group in detail.groups %}
              <a class="govuk-link" href="{{ group.group_url }}" target="_blank" rel="noopener noreferrer">{{ group.group_name }}</a>{% if not loop.last %}, {% endif %}
            {% endfor %}
          </td>
        </tr>
            {% endfor %}
          {% endif %}
        {% endfor %}
      </tbody>
    </table>
  </section>

  <!-- Chart.js Library -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <script>
    // Search functionality - filter individual rows and adjust rowspan
    document.getElementById('access-search').addEventListener('input', function() {
      const query = this.value.toLowerCase().trim();
      const terms = query.split(/\s+/);
      const rows = document.querySelectorAll('#access-table-body tr');
      
      let currentAppRows = [];
      let currentAppName = null;
      
      rows.forEach((row) => {
        // Check if this row has app name cell (first row of an app group)
        const hasAppName = row.cells[0].hasAttribute('rowspan');
        
        if (hasAppName) {
          // Process previous app group
          if (currentAppRows.length > 0) {
            processAppGroup(currentAppRows, currentAppName);
          }
          
          // Start new app group - store app name info
          currentAppName = row.cells[0].cloneNode(true);
          currentAppRows = [row];
        } else {
          // This is a continuation row for the same app
          currentAppRows.push(row);
        }
      });
      
      // Process last app group
      if (currentAppRows.length > 0) {
        processAppGroup(currentAppRows, currentAppName);
      }
      
      function processAppGroup(appRows, appNameCell) {
        // Check which rows match the search
        const matchingRows = appRows.filter(row => {
          // Get individual cell values (excluding app name which may have rowspan)
          const cells = row.cells;
          const cellIndex = cells[0].hasAttribute('rowspan') ? 0 : -1;
          
          const appName = (cellIndex === 0 ? cells[0] : appNameCell).textContent.toLowerCase();
          const environment = cells[cellIndex + 1].textContent.toLowerCase();
          const accessLevel = cells[cellIndex + 2].textContent.toLowerCase();
          const groupName = cells[cellIndex + 3].textContent.toLowerCase();
          
          // Check if all search terms match
          return terms.every(term => {
            // For group names, require exact match
            if (groupName === term) {
              return true;
            }
            // For environment, use word boundary matching to prevent "production" matching "preproduction"
            const envMatch = new RegExp('\\b' + term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b').test(environment);
            // For other fields, use contains matching
            return appName.includes(term) || 
                   envMatch || 
                   accessLevel.includes(term);
          });
        });
        
        if (matchingRows.length === 0) {
          // Hide all rows for this app
          appRows.forEach(r => r.style.display = 'none');
        } else {
          // Show only matching rows
          appRows.forEach(r => r.style.display = 'none');
          matchingRows.forEach(r => r.style.display = '');
          
          // Update the first visible row to have the app name cell with correct rowspan
          const firstVisibleRow = matchingRows[0];
          
          if (firstVisibleRow.cells[0].hasAttribute('rowspan')) {
            firstVisibleRow.cells[0].setAttribute('rowspan', matchingRows.length);
          } else {
            const newAppNameCell = appNameCell.cloneNode(true);
            newAppNameCell.setAttribute('rowspan', matchingRows.length);
            firstVisibleRow.insertBefore(newAppNameCell, firstVisibleRow.firstChild);
          }
        }
      }
    });

    // Chart.js visualization
    const ctx = document.getElementById('roleUsageChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: {{ role_counts.keys() | list | tojson }},
        datasets: [{
          label: 'Number of Environments',
          data: {{ role_counts.values() | list | tojson }},
          backgroundColor: [
            '#1d70b8', // GOV.UK blue
            '#d4351c', // GOV.UK red
            '#00703c', // GOV.UK green
            '#f47738', // GOV.UK orange
            '#5694ca', // GOV.UK light blue
            '#912b88', // GOV.UK purple
            '#ffdd00', // GOV.UK yellow
            '#b1b4b6'  // GOV.UK grey
          ],
          borderColor: '#ffffff',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        indexAxis: 'y', // This makes it horizontal
        plugins: {
          legend: {
            display: false
          },
          title: {
            display: false
          }
        },
        scales: {
          x: {
            beginAtZero: true,
            ticks: {
              stepSize: 1
            },
            title: {
              display: true,
              text: 'Count'
            }
          },
          y: {
            title: {
              display: true,
              text: 'Access Role'
            }
          }
        }
      }
    });
  </script>
  
  {% endblock %}
